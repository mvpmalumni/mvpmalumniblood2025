<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mega Blood Donation CAMP 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    header {
      background:#c62828;
      color:white;
      padding:14px;
      text-align:center;
      font-size:18px;
      font-weight:bold;
      position:relative;
    }
    #locBtn {
      position:absolute;
      right:10px;
      top:10px;
      background:white;
      color:#c62828;
      border:none;
      padding:8px 10px;
      font-size:14px;
      border-radius:6px;
      cursor:pointer;
      font-weight:bold;
    }
    #map { height:75vh; width:100%; }
    #panel {
      height:25vh;
      background:#fff;
      border-top:2px solid #ddd;
      padding:12px;
      display:none;
    }
    .title { font-weight:bold; font-size:17px; margin-bottom:6px; }
    .meta { color:#555; margin-bottom:6px; }
    .dist { font-weight:bold; margin-bottom:10px; }
    #navBtn {
      background:#1565c0;
      color:white;
      padding:10px 12px;
      border-radius:6px;
      text-decoration:none;
      font-weight:bold;
      display:inline-block;
    }
  </style>
</head>
<body>

  <header>
    Mega Blood Donation CAMP 2025<br>
    Organized by MVPM Alumni & MVPM Across Maharashtra
    <button id="locBtn">Use My Location</button>
  </header>

  <div id="map"></div>

  <!-- Info Panel -->
  <div id="panel">
    <div class="title" id="cName"></div>
    <div class="meta" id="cAddr"></div>
    <div class="dist" id="cDist"></div>
    <a id="navBtn" href="#" target="_blank">Navigate</a>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let centers = [];
    let map;
    let userMarker = null;

    // Load centres.json
    fetch('centres.json')
      .then(r => r.json())
      .then(data => {
        centers = data;
        initMap();
      });

    function initMap(){
      map = L.map('map').setView([19.7515, 75.7139], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Add markers
      centers.forEach(c => {
        L.marker([c.lat, c.lng]).addTo(map)
          .bindPopup(`<b>${c.name}</b><br>${c.area}, ${c.city}`);
      });

      // Click on map
      map.on('click', function(e){
        showNearest(e.latlng.lat, e.latlng.lng);
      });
    }

    // USE MY LOCATION
    document.getElementById('locBtn').onclick = function(){
      if(!navigator.geolocation){
        alert("Geolocation not supported");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if(userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lat, lng], {color:'red'}).addTo(map);

        map.setView([lat, lng], 12);

        showNearest(lat, lng);
      }, () => {
        alert("Location access denied");
      });
    };

    // FIND NEAREST CENTRE
    function showNearest(lat, lng){
      let nearest = null;
      let minD = Infinity;

      centers.forEach(c => {
        let d = distance(lat, lng, c.lat, c.lng);
        if(d < minD){
          minD = d;
          nearest = c;
        }
      });

      if(nearest){
        showPanel(nearest, minD);
      }
    }

    // UPDATE PANEL
    function showPanel(center, dist){
      document.getElementById('cName').textContent = center.name;
      document.getElementById('cAddr').textContent = `${center.area}, ${center.city}`;
      document.getElementById('cDist').textContent = `Distance: ${dist.toFixed(2)} km`;
      document.getElementById('navBtn').href =
        `https://www.google.com/maps/dir/?api=1&destination=${center.lat},${center.lng}`;
      document.getElementById('panel').style.display = 'block';
    }

    // Distance function
    function distance(lat1, lon1, lat2, lon2){
      const R = 6371;
      const dLat = (lat2-lat1) * Math.PI/180;
      const dLon = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 +
        Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
        Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

  </script>
</body>
</html>

